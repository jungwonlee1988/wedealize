<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeDealize - Accept Team Invitation</title>
    <link rel="icon" type="image/png" href="./favicon.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="design-system.css">
</head>
<body>
    <div class="portal-app">
        <header class="portal-header">
            <div class="header-content">
                <div class="logo">
                    <img src="logo.png" alt="WeDealize" height="32">
                </div>
            </div>
        </header>

        <section class="auth-section" style="display: flex; justify-content: center; align-items: center; min-height: calc(100vh - 64px);">
            <div class="wd-auth-card" style="max-width: 480px; width: 100%;">

                <!-- Loading state -->
                <div class="wd-auth-form active" id="loading-state">
                    <div style="text-align: center; padding: 40px 0;">
                        <div class="wd-spinner" style="width: 48px; height: 48px; border: 3px solid #e2e8f0; border-top-color: #0F4C81; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 20px;"></div>
                        <h2 class="wd-auth-title">Processing Invitation</h2>
                        <p class="wd-auth-subtitle">Please wait while we verify your invitation...</p>
                    </div>
                </div>

                <!-- Success -->
                <div class="wd-auth-form" id="success-state" style="display: none;">
                    <div style="text-align: center;">
                        <div class="wd-success-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--wd-success)" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        </div>
                        <h2 class="wd-auth-title">Welcome to the Team!</h2>
                        <p class="wd-auth-subtitle">You have successfully joined the team. You can now access the Supplier Portal.</p>
                        <button type="button" class="wd-btn wd-btn-primary wd-btn-full" onclick="window.location.href='portal.html'" style="margin-top: 24px;">Go to Portal</button>
                    </div>
                </div>

                <!-- Already have account - auto link -->
                <div class="wd-auth-form" id="login-state" style="display: none;">
                    <div style="text-align: center;">
                        <div class="wd-success-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#0F4C81" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                        </div>
                        <h2 class="wd-auth-title">Accept Invitation</h2>
                        <p class="wd-auth-subtitle" id="invite-details"></p>
                        <button type="button" class="wd-btn wd-btn-primary wd-btn-full" id="accept-btn" onclick="acceptInvitation()" style="margin-top: 24px;">Accept & Join Team</button>
                        <p style="margin-top: 16px; font-size: 13px; color: #94a3b8;">
                            Not you? <a href="portal.html" style="color: #0F4C81;">Sign in with a different account</a>
                        </p>
                    </div>
                </div>

                <!-- Need to sign up first -->
                <div class="wd-auth-form" id="signup-state" style="display: none;">
                    <div style="text-align: center;">
                        <div class="wd-success-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#0F4C81" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="8.5" cy="7" r="4"/>
                                <line x1="20" y1="8" x2="20" y2="14"/>
                                <line x1="23" y1="11" x2="17" y2="11"/>
                            </svg>
                        </div>
                        <h2 class="wd-auth-title">Create Your Account</h2>
                        <p class="wd-auth-subtitle">You need a WeDealize account to accept this invitation. Please sign up first, then click the invitation link again.</p>
                        <button type="button" class="wd-btn wd-btn-primary wd-btn-full" onclick="window.location.href='portal.html#signup'" style="margin-top: 24px;">Sign Up</button>
                        <p style="margin-top: 16px; font-size: 13px; color: #94a3b8;">
                            Already have an account? <a href="portal.html" style="color: #0F4C81;">Sign in</a>
                        </p>
                    </div>
                </div>

                <!-- Error -->
                <div class="wd-auth-form" id="error-state" style="display: none;">
                    <div style="text-align: center;">
                        <div class="wd-success-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                        </div>
                        <h2 class="wd-auth-title">Invalid Invitation</h2>
                        <p class="wd-auth-subtitle" id="error-message">This invitation link is invalid or has expired. Please ask the team admin to send a new invitation.</p>
                        <button type="button" class="wd-btn wd-btn-primary wd-btn-full" onclick="window.location.href='portal.html'" style="margin-top: 24px;">Go to Portal</button>
                    </div>
                </div>

            </div>
        </section>
    </div>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <script>
        const API_BASE_URL = 'https://supplier-api-blush.vercel.app/api/v1/supplier';
        let inviteToken = null;

        function getTokenFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('token');
        }

        function showState(stateId) {
            ['loading-state', 'success-state', 'login-state', 'signup-state', 'error-state'].forEach(id => {
                document.getElementById(id).style.display = id === stateId ? 'block' : 'none';
            });
        }

        async function init() {
            inviteToken = getTokenFromURL();

            if (!inviteToken) {
                document.getElementById('error-message').textContent = 'No invitation token found. Please use the link from your invitation email.';
                showState('error-state');
                return;
            }

            // Fetch invite info from backend
            let inviteInfo;
            try {
                const res = await fetch(API_BASE_URL + '/team/invite-info?token=' + encodeURIComponent(inviteToken));
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.message || 'Invalid invitation');
                }
                inviteInfo = await res.json();
            } catch (e) {
                document.getElementById('error-message').textContent = e.message || 'This invitation link is invalid or has expired.';
                showState('error-state');
                return;
            }

            const invitedEmail = inviteInfo.email;
            const companyName = inviteInfo.companyName;

            // Check if user is logged in
            const token = localStorage.getItem('supplier_token');

            if (token) {
                // Decode JWT to get logged-in email
                let loggedInEmail = '';
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    loggedInEmail = payload.email || '';
                } catch (e) { /* ignore */ }

                if (loggedInEmail.toLowerCase() === invitedEmail.toLowerCase()) {
                    // Logged-in email matches invited email — show accept button
                    showState('login-state');
                    document.getElementById('invite-details').textContent =
                        'You have been invited to join ' + companyName + ' as ' + inviteInfo.role + '. Click the button below to accept.';
                } else {
                    // Logged in as different account
                    showState('signup-state');
                    document.querySelector('#signup-state .wd-auth-title').textContent = 'Different Account';
                    document.querySelector('#signup-state .wd-auth-subtitle').textContent =
                        'This invitation was sent to ' + invitedEmail + ', but you are logged in as ' + loggedInEmail + '. Please log out and sign in with the correct account.';
                    document.querySelector('#signup-state .wd-btn').textContent = 'Go to Sign In';
                    document.querySelector('#signup-state .wd-btn').onclick = function() { window.location.href = 'portal.html'; };
                }
            } else {
                // Not logged in — show signup/login guidance
                document.querySelector('#signup-state .wd-auth-subtitle').textContent =
                    'This invitation was sent to ' + invitedEmail + '. Please sign up or sign in with that email first, then click the invitation link again.';
                showState('signup-state');
            }
        }

        async function acceptInvitation() {
            const btn = document.getElementById('accept-btn');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Accepting...';
            }

            try {
                const response = await fetch(`${API_BASE_URL}/team/accept-invite`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: inviteToken })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || 'Failed to accept invitation');
                }

                const data = await response.json();
                showState('success-state');

            } catch (error) {
                console.error('Accept invite error:', error);
                document.getElementById('error-message').textContent = error.message || 'This invitation link is invalid or has expired.';
                showState('error-state');
            }
        }

        // Initialize
        init();
    </script>
</body>
</html>
