<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeDealize - Reset Password</title>
    <link rel="icon" type="image/png" href="./favicon.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="design-system.css">
</head>
<body>
    <div class="portal-app">
        <header class="portal-header">
            <div class="header-content">
                <div class="logo">
                    <img src="logo.png" alt="WeDealize" height="32">
                </div>
            </div>
        </header>

        <section class="auth-section" style="display: flex; justify-content: center; align-items: center; min-height: calc(100vh - 64px);">
            <div class="wd-auth-card" style="max-width: 420px; width: 100%;">
                <!-- Reset Password Form -->
                <div class="wd-auth-form active" id="reset-form">
                    <h2 class="wd-auth-title">Set New Password</h2>
                    <p class="wd-auth-subtitle">Enter your new password below.</p>

                    <div class="wd-form-group">
                        <label class="wd-form-label" for="new-password">New Password</label>
                        <input type="password" class="wd-input" id="new-password" placeholder="Enter new password" required minlength="8">
                    </div>

                    <div class="wd-form-group">
                        <label class="wd-form-label" for="confirm-password">Confirm Password</label>
                        <input type="password" class="wd-input" id="confirm-password" placeholder="Confirm new password" required minlength="8">
                    </div>

                    <button type="button" class="wd-btn wd-btn-primary wd-btn-full" id="reset-btn" onclick="resetPassword()">Reset Password</button>
                </div>

                <!-- Success -->
                <div class="wd-auth-form" id="success-form" style="display: none;">
                    <div class="wd-success-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--wd-success)" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    </div>
                    <h2 class="wd-auth-title">Password Reset Complete</h2>
                    <p class="wd-auth-subtitle">Your password has been changed successfully.</p>
                    <button type="button" class="wd-btn wd-btn-primary wd-btn-full" onclick="window.location.href='portal.html'">Back to Login</button>
                </div>

                <!-- Error -->
                <div class="wd-auth-form" id="error-form" style="display: none;">
                    <div class="wd-success-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                    </div>
                    <h2 class="wd-auth-title">Invalid or Expired Link</h2>
                    <p class="wd-auth-subtitle">This password reset link is invalid or has expired. Please request a new one.</p>
                    <button type="button" class="wd-btn wd-btn-primary wd-btn-full" onclick="window.location.href='portal.html'">Back to Login</button>
                </div>
            </div>
        </section>
    </div>

    <script>
        const API_BASE_URL = 'https://supplier-api-blush.vercel.app/api/v1/supplier';

        function getTokenFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('token');
        }

        const token = getTokenFromURL();
        if (!token) {
            document.getElementById('reset-form').style.display = 'none';
            document.getElementById('error-form').style.display = 'block';
        }

        async function resetPassword() {
            const password = document.getElementById('new-password').value;
            const confirm = document.getElementById('confirm-password').value;

            if (!password || password.length < 8) {
                alert('Password must be at least 8 characters.');
                return;
            }

            if (password !== confirm) {
                alert('Passwords do not match.');
                return;
            }

            const btn = document.getElementById('reset-btn');
            btn.disabled = true;
            btn.textContent = 'Resetting...';

            try {
                const response = await fetch(`${API_BASE_URL}/auth/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, password })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || 'Failed to reset password');
                }

                document.getElementById('reset-form').style.display = 'none';
                document.getElementById('success-form').style.display = 'block';
            } catch (error) {
                console.error('Reset error:', error);
                document.getElementById('reset-form').style.display = 'none';
                document.getElementById('error-form').style.display = 'block';
            }
        }
    </script>
</body>
</html>
